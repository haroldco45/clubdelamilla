<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Club de la Milla | Vibras Positivas</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #2c3e50; --accent: #27ae60; --bg: #f8f9fa; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg); margin: 0; padding: 10px; display: flex; justify-content: center; }
        .container { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 500px; }
        .reloj-container { text-align: center; background: var(--primary); color: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; }
        #reloj { font-size: 1.6em; font-weight: 600; }
        .btn { width: 100%; padding: 14px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; margin-top: 10px; }
        .btn-go { background: var(--accent); color: white; }
        .stats { background: #f1f8f5; padding: 20px; border-radius: 15px; margin: 15px 0; border-left: 6px solid var(--accent); text-align: center; }
        #loginSection, #appSection, #adminPanel { display: none; }
        .active { display: block !important; }
        .gps-indicator { font-size: 0.85em; font-weight: bold; margin-bottom: 10px; display: block; text-align: center; padding: 10px; border-radius: 8px; border: 1px solid #ddd; }
        .checkpoint-list { display: flex; justify-content: space-around; margin: 10px 40px; }
        .dot { width: 45px; height: 45px; border-radius: 50%; background: #ddd; border: 2px solid #bbb; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #777; transition: 0.3s; }
        .dot.active { background: var(--accent); border-color: #1b5e20; box-shadow: 0 0 15px var(--accent); color: white; transform: scale(1.1); }
        input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        #avisoExito { background: #e8f5e9; color: #2e7d32; padding: 12px; border-radius: 10px; margin-top: 15px; font-weight: bold; display: none; text-align: center; border: 1px solid #c8e6c9; animation: fade 0.5s; }
        @keyframes fade { from {opacity: 0;} to {opacity: 1;} }
    </style>
</head>
<body onload="iniciarReloj()">

<div class="container">
    <div style="text-align: center; margin-bottom: 10px;">
        <strong style="color: var(--accent); letter-spacing: 1px;">‚ú® VIBRAS POSITIVAS</strong>
    </div>

    <div class="reloj-container">
        <div id="fecha">Cargando fecha...</div>
        <div id="reloj">--:--:-- --</div>
    </div>

    <div id="loginSection" class="active">
        <h2 style="text-align:center;">Club de la Milla</h2>
        <input type="text" id="regNombre" placeholder="Tu Nombre">
        <input type="email" id="email" placeholder="Tu Correo">
        <button class="btn btn-go" onclick="autenticar()">INGRESAR</button>
    </div>

    <div id="appSection">
        <h3 id="displayUser" style="text-align:center;">üèÉ PARTICIPANTE</h3>
        
        <div id="gpsPrompt" style="background: #e3f2fd; padding: 15px; border-radius: 10px; text-align: center; margin-bottom: 15px; border: 1px solid #2196f3;">
            <button onclick="activarSensorGPS()" style="background: #2196f3; color:white; border:none; padding:12px; border-radius:5px; font-weight:bold; cursor:pointer; width:100%;">üì° ACTIVAR GPS RUTA 2 PUNTOS</button>
        </div>

        <span id="gpsStatus" class="gps-indicator" style="background: #f8f9fa;">Esperando ubicaci√≥n...</span>
        
        <div style="text-align: center; margin-bottom: 10px;">
            <small>Ruta: Salida(1) ‚Üí Mitad(2) ‚Üí Meta(1)</small>
            <div class="checkpoint-list">
                <div id="dot0" class="dot">1</div>
                <div id="dot1" class="dot">2</div>
            </div>
        </div>

        <div class="stats">
            <small>VUELTAS VALIDADAS</small>
            <div style="font-size: 3.5em; font-weight: 600;" id="misVueltas">0</div>
            <div id="avisoExito">¬°VUELTA REGISTRADA! ‚ú®</div>
        </div>

        <div id="adminPanel" style="background: #fff3e0; padding: 15px; border-radius: 12px; margin-top: 20px; border: 1px solid #ff9800;">
            <h4 style="text-align: center; margin: 0;">‚öôÔ∏è Panel Admin Harold</h4>
            <button class="btn" style="background:#2c3e50; color:white; font-size:0.8em;" onclick="exportarInforme()">üì• Descargar Excel Local</button>
        </div>
    </div>
</div>

<script>
    let vLocales = 0;
    let progresoActual = [false, false]; 
    let bloqueado = false; 
    let dbHistorial = [];
    const bell = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');

    const ADMIN_EMAIL = "haroldco45@gmail.com"; 
    const URL_GOOGLE_SHEETS = "https://script.google.com/macros/s/AKfycbyJG2u-g4YXTRKRRXrTb6EKse7_K2TdUeVpWeLMn7S94EGZl5iLThZ3V0FGaiFV0GtOrA/exec";

    // COORDENADAS CAPTURADAS POR HAROLD
    const puntosFijos = [
        { lat: 7.9893462, lon: -75.1968626 }, // Punto 1: Salida
        { lat: 7.9895668, lon: -75.197858 }   // Punto 2: Mitad
    ];

    function iniciarReloj() {
        setInterval(() => {
            const ahora = new Date();
            document.getElementById('fecha').innerText = ahora.toLocaleDateString('es-CO');
            document.getElementById('reloj').innerText = ahora.toLocaleTimeString('en-US');
        }, 1000);
    }

    function activarSensorGPS() {
        navigator.geolocation.watchPosition(pos => {
            if (bloqueado) return; 

            const status = document.getElementById('gpsStatus');
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            status.innerText = "üìç GPS ACTIVO - EN RUTA";

            // 1. Detectar Salida (Punto 1)
            if (!progresoActual[0]) {
                if (calcularDist(lat, lon, puntosFijos[0].lat, puntosFijos[0].lon) <= 0.020) {
                    marcarPunto(0);
                }
            } 
            // 2. Detectar Mitad (Punto 2)
            else if (progresoActual[0] && !progresoActual[1]) {
                if (calcularDist(lat, lon, puntosFijos[1].lat, puntosFijos[1].lon) <= 0.025) {
                    marcarPunto(1);
                }
            }
            // 3. Regreso a Salida (Meta)
            else if (progresoActual[1]) {
                if (calcularDist(lat, lon, puntosFijos[0].lat, puntosFijos[0].lon) <= 0.020) {
                    registrarVueltaAuto();
                }
            }

        }, null, { enableHighAccuracy: true, maximumAge: 0 });
        document.getElementById('gpsPrompt').style.display = 'none';
    }

    function marcarPunto(idx) {
        progresoActual[idx] = true;
        document.getElementById('dot'+idx).classList.add('active');
        bell.play();
        if(navigator.vibrate) navigator.vibrate(200);
    }

    function registrarVueltaAuto() {
        bloqueado = true; 
        vLocales++;
        document.getElementById('misVueltas').innerText = vLocales;
        
        const ahora = new Date();
        const datos = { 
            Nombre: document.getElementById('regNombre').value, 
            Vueltas: vLocales, 
            Fecha: ahora.toLocaleDateString('es-CO'), 
            Hora: ahora.toLocaleTimeString('en-US'),
            Correo: document.getElementById('email').value 
        };
        dbHistorial.push(datos);

        fetch(URL_GOOGLE_SHEETS, { method: 'POST', mode: 'no-cors', body: JSON.stringify(datos) });

        const aviso = document.getElementById('avisoExito');
        aviso.style.display = 'block';
        
        // REDUCIDO A 3 SEGUNDOS PARA QUE NO TENGAS QUE DEVOLVERTE
        setTimeout(() => {
            aviso.style.display = 'none';
            progresoActual = [false, false];
            document.getElementById('dot0').classList.remove('active');
            document.getElementById('dot1').classList.remove('active');
            bloqueado = false; 
        }, 3000); 
    }

    function calcularDist(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = (lat2-lat1)*Math.PI/180;
        const dLon = (lon2-lon1)*Math.PI/180;
        const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function autenticar() {
        const n = document.getElementById('regNombre').value;
        const e = document.getElementById('email').value.toLowerCase();
        if(n && e) {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('appSection').classList.add('active');
            document.getElementById('displayUser').innerText = "üèÉ PARTICIPANTE: " + n.toUpperCase();
            if (e === ADMIN_EMAIL) document.getElementById('adminPanel').classList.add('active');
        }
    }

    function exportarInforme() {
        const ws = XLSX.utils.json_to_sheet(dbHistorial);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Auditoria");
        XLSX.writeFile(wb, "Reporte_ClubMilla.xlsx");
    }
</script>
</body>
</html>
