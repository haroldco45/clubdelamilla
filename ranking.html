<script>
    const URL_GOOGLE = "https://script.google.com/macros/s/AKfycbyJG2u-g4YXTRKRRXrTb6EKse7_K2TdUeVpWeLMn7S94EGZl5iLThZ3V0FGaiFV0GtOrA/exec";
    const META_KM = 60;

    async function cargarRanking() {
        try {
            const response = await fetch(URL_GOOGLE);
            const data = await response.json();
            
            // LÃ“GICA DE FILTRADO POR SESIÃ“N DIARIA
            const diario = {}; 

            data.forEach(item => {
                const nombre = item.Nombre ? item.Nombre.trim() : "AnÃ³nimo";
                const vueltas = parseInt(item.Vueltas) || 0;
                const fecha = item.Fecha; // Usamos la fecha para separar sesiones
                const llave = nombre + "_" + fecha;

                // Para cada persona en un mismo dÃ­a, solo guardamos su rÃ©cord mÃ¡s alto
                if (!diario[llave] || vueltas > diario[llave]) {
                    diario[llave] = vueltas;
                }
            });

            // Ahora sumamos los totales mÃ¡ximos de cada dÃ­a para cada persona
            const resumenFinal = {};
            for (const llave in diario) {
                const nombre = llave.split("_")[0];
                if (!resumenFinal[nombre]) {
                    resumenFinal[nombre] = diario[llave];
                } else {
                    resumenFinal[nombre] += diario[llave];
                }
            }

            const listaOrdenada = Object.keys(resumenFinal).map(nombre => {
                return { nombre: nombre, vueltas: resumenFinal[nombre] };
            }).sort((a, b) => b.vueltas - a.vueltas);

            let html = `<table><tr><th>Pos</th><th style="text-align:left;">Corredor</th><th>Progreso</th><th>Dist.</th></tr>`;

            listaOrdenada.slice(0, 10).forEach((user, index) => {
                const km = (user.vueltas / 3).toFixed(1);
                const porcentaje = Math.min((km / META_KM) * 100, 100).toFixed(0);
                const esVirtual = user.nombre.includes("(VIRTUAL)");
                const nombreMostrar = user.nombre.replace("(VIRTUAL)", "").trim();
                const esPrimero = index === 0;

                html += `<tr class="${esPrimero ? 'top-1' : ''}">
                    <td class="pos">${esPrimero ? '<span class="crown">ðŸ‘‘</span>' : (index + 1) + 'Âº'}</td>
                    <td style="text-align:left; font-size:0.9em;">
                        ${nombreMostrar} ${esVirtual ? '<span class="virtual-tag">VIRTUAL</span>' : ''}
                        <div class="progress-container"><div class="progress-bar" style="width: ${porcentaje}%"></div></div>
                    </td>
                    <td style="font-size:0.75em; color:#666;">${porcentaje}%</td>
                    <td><span class="km-badge">${km}k</span></td>
                </tr>`;
            });

            html += `</table>`;
            document.getElementById('tablaRanking').innerHTML = html;

        } catch (e) {
            document.getElementById('tablaRanking').innerHTML = "<p>Sincronizando registros...</p>";
        }
    }

    setInterval(cargarRanking, 30000); 
    cargarRanking();
</script>
