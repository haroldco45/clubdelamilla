<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reto Superarroz | Club de la Milla</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root { --vibras-green: #27ae60; --vibras-dark: #2c3e50; --gold: #f1c40f; --superarroz: #e67e22; }
        body { font-family: 'Poppins', sans-serif; background: #f4f7f6; padding: 15px; text-align: center; color: var(--vibras-dark); }
        .ranking-card { background: white; padding: 25px; border-radius: 25px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); max-width: 600px; margin: 0 auto; border-top: 8px solid var(--vibras-green); }
        h2 { margin-bottom: 5px; color: var(--vibras-green); letter-spacing: 1px; text-transform: uppercase; }
        .challenge-box { background: #fff9c4; padding: 15px; border-radius: 12px; border: 2px dashed var(--superarroz); margin-bottom: 20px; }
        .subtitle { font-size: 0.95em; color: var(--vibras-dark); font-weight: 600; line-height: 1.4; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: #fff; }
        th { background: #f8f9fa; color: #888; padding: 12px; font-size: 0.7em; text-transform: uppercase; }
        td { padding: 15px 5px; border-bottom: 1px solid #f1f1f1; font-weight: 500; font-size: 0.9em; }
        .pos { font-weight: 600; color: var(--vibras-green); width: 35px; }
        .top-1 { background: #fffdf2; }
        .progress-container { width: 100%; background-color: #eee; border-radius: 10px; height: 8px; margin-top: 5px; }
        .progress-bar { height: 100%; border-radius: 10px; background: linear-gradient(to right, #27ae60, #f1c40f); transition: width 1s ease-in-out; }
        .km-badge { background: #e8f5e9; color: #2e7d32; padding: 4px 8px; border-radius: 12px; font-size: 0.8em; font-weight: 600; display: block; margin-top: 2px; }
        .vueltas-text { font-size: 0.75em; color: #666; font-weight: 400; display: block; }
        .virtual-tag { font-size: 0.5em; background: #9b59b6; color: white; padding: 1px 4px; border-radius: 3px; vertical-align: middle; }
    </style>
</head>
<body>
    <div class="ranking-card">
        <h2>üèÜ CLUB DE LA MILLA</h2>
        <div class="challenge-box">
            <div class="subtitle">üåæ RETO SUPERARROZ üåæ<br>¬°Los primeros 60 KM ganan 1 paca de arroz!</div>
        </div>
        <div id="tablaRanking">Sincronizando registros...</div>
    </div>

    <script>
        const URL_GOOGLE = "https://script.google.com/macros/s/AKfycbyJG2u-g4YXTRKRRXrTb6EKse7_K2TdUeVpWeLMn7S94EGZl5iLThZ3V0FGaiFV0GtOrA/exec";
        const META_KM = 60;

        async function cargarRanking() {
            try {
                const response = await fetch(URL_GOOGLE);
                const data = await response.json();
                const sesiones = {}; 

                data.forEach(item => {
                    const nombre = item.Nombre ? item.Nombre.trim() : "An√≥nimo";
                    const vueltas = parseInt(item.Vueltas) || 0;
                    const fechaRaw = item.Fecha ? item.Fecha.toString().split('T')[0] : "SinFecha";
                    const llave = nombre + "_" + fechaRaw;

                    if (!sesiones[llave] || vueltas > sesiones[llave]) {
                        sesiones[llave] = vueltas;
                    }
                });

                const totales = {};
                for (const llave in sesiones) {
                    const nombre = llave.split("_")[0];
                    if (!totales[nombre]) { totales[nombre] = sesiones[llave]; } 
                    else { totales[nombre] += sesiones[llave]; }
                }

                const lista = Object.keys(totales).map(n => ({ nombre: n, vueltas: totales[n] }))
                              .sort((a, b) => b.vueltas - a.vueltas);

                let html = `<table><tr><th>Pos</th><th style="text-align:left;">Participante</th><th>Progreso</th><th>Total</th></tr>`;

                lista.slice(0, 10).forEach((user, index) => {
                    const km = (user.vueltas / 3).toFixed(1);
                    const porcentaje = Math.min((km / META_KM) * 100, 100).toFixed(0);
                    const esVirtual = user.nombre.includes("(VIRTUAL)");
                    const nombreMostrar = user.nombre.replace("(VIRTUAL)", "").trim();
                    
                    html += `<tr class="${index === 0 ? 'top-1' : ''}">
                        <td class="pos">${index === 0 ? 'üëë' : (index + 1) + '¬∫'}</td>
                        <td style="text-align:left;">
                            <span style="font-weight:600;">${nombreMostrar}</span> ${esVirtual ? '<span class="virtual-tag">V</span>' : ''}
                            <div class="progress-container"><div class="progress-bar" style="width: ${porcentaje}%"></div></div>
                        </td>
                        <td style="font-size:0.8em; color:#666;">${porcentaje}%</td>
                        <td>
                            <span class="vueltas-text">${user.vueltas} Vueltas</span>
                            <span class="km-badge">${km}k</span>
                        </td>
                    </tr>`;
                });

                html += `</table>`;
                document.getElementById('tablaRanking').innerHTML = html;

            } catch (e) {
                document.getElementById('tablaRanking').innerHTML = "Actualizando datos...";
            }
        }

        setInterval(cargarRanking, 30000); 
        cargarRanking();
    </script>
</body>
</html>
