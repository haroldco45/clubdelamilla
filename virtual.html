<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Milla Virtual | Global</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #2c3e50; --accent: #9b59b6; --bg: #f4f7f6; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg); margin: 0; padding: 10px; display: flex; justify-content: center; }
        .container { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 500px; }
        .header { text-align: center; background: var(--accent); color: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; }
        .stats { background: #f3e5f5; padding: 20px; border-radius: 15px; margin: 15px 0; border-left: 6px solid var(--accent); text-align: center; }
        #loginSection, #appSection { display: none; }
        .active { display: block !important; }
        .btn { width: 100%; padding: 14px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; margin-top: 10px; color: white; }
    </style>
</head>
<body onload="verificarUsuario()">
<div class="container">
    <div class="header">
        <strong style="letter-spacing: 1px;">üåç MILLA VIRTUAL GLOBAL</strong>
        <div id="reloj">00:00:00</div>
    </div>

    <div id="loginSection" class="active">
        <input type="text" id="regNombre" placeholder="Tu Nombre" style="width:100%; box-sizing:border-box; padding:12px; margin-bottom:10px; border:1px solid #ddd; border-radius:8px;">
        <input type="email" id="email" placeholder="Tu Correo" style="width:100%; box-sizing:border-box; padding:12px; margin-bottom:10px; border:1px solid #ddd; border-radius:8px;">
        <button class="btn" style="background: var(--accent);" onclick="autenticar()">INICIAR DESAF√çO</button>
    </div>

    <div id="appSection">
        <h3 id="displayUser" style="text-align:center;">üèÉ CORREDOR GLOBAL</h3>
        <span onclick="cerrarSesion()" style="display:block; text-align:center; font-size:0.7em; color:#888; cursor:pointer;">Cambiar de usuario</span>
        
        <div id="velocidad" style="text-align:center; font-weight:bold; color:var(--accent); margin-top:15px;">Velocidad: 0.0 km/h</div>
        <div class="stats">
            <small>DISTANCIA RECORRIDA</small>
            <div style="font-size: 2.5em; font-weight: 600;" id="distancia">0 m</div>
            <hr>
            <small>VUELTAS VIRTUALES (300m c/u)</small>
            <div style="font-size: 2em; font-weight: 600;" id="vueltas">0</div>
        </div>
    </div>
</div>

<script>
    let vLocales = 0, distanciaTotal = 0, ultimaPos = null;
    const METROS_VUELTA = 300;
    const URL_SHEETS = "https://script.google.com/macros/s/AKfycbyJG2u-g4YXTRKRRXrTb6EKse7_K2TdUeVpWeLMn7S94EGZl5iLThZ3V0FGaiFV0GtOrA/exec";

    function iniciarReloj() { setInterval(() => { document.getElementById('reloj').innerText = new Date().toLocaleTimeString(); }, 1000); }

    function verificarUsuario() {
        iniciarReloj();
        const guardado = localStorage.getItem('usuarioMilla');
        if (guardado) {
            const user = JSON.parse(guardado);
            document.getElementById('regNombre').value = user.nombre;
            document.getElementById('email').value = user.email;
            autenticar(true);
        }
    }

    function autenticar(esAutomatico = false) {
        const nom = document.getElementById('regNombre').value;
        const em = document.getElementById('email').value;
        if(nom && em) {
            if(!esAutomatico) {
                localStorage.setItem('usuarioMilla', JSON.stringify({nombre: nom, email: em}));
            }
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('appSection').classList.add('active');
            document.getElementById('displayUser').innerText = "üèÉ " + nom.toUpperCase();
            speak("Iniciando ruta virtual.");
            iniciarGps();
        }
    }

    function cerrarSesion() {
        localStorage.removeItem('usuarioMilla');
        location.reload();
    }

    function iniciarGps() {
        navigator.geolocation.watchPosition(pos => {
            const lat = pos.coords.latitude, lon = pos.coords.longitude;
            const vel = pos.coords.speed ? (pos.coords.speed * 3.6).toFixed(1) : "0.0";
            document.getElementById('velocidad').innerText = `Velocidad: ${vel} km/h`;

            if (ultimaPos) {
                const d = calc(ultimaPos.lat, ultimaPos.lon, lat, lon);
                if (d > 0.8) { 
                    distanciaTotal += d; 
                    document.getElementById('distancia').innerText = Math.round(distanciaTotal) + " m";
                    if (distanciaTotal >= (vLocales + 1) * METROS_VUELTA) registrar();
                }
            }
            ultimaPos = {lat, lon};
        }, null, { enableHighAccuracy: true });
    }

    function registrar() {
        vLocales++;
        document.getElementById('vueltas').innerText = vLocales;
        speak("Vuelta completada");

        fetch(URL_SHEETS, { method: 'POST', mode: 'no-cors', body: JSON.stringify({
            Nombre: document.getElementById('regNombre').value + " (VIRTUAL)",
            Vueltas: vLocales, Correo: document.getElementById('email').value,
            Fecha: new Date().toLocaleDateString(), Hora: new Date().toLocaleTimeString()
        })});
    }

    function speak(t) { const m = new SpeechSynthesisUtterance(t); m.lang = 'es-ES'; window.speechSynthesis.speak(m); }

    function calc(lat1, lon1, lat2, lon2) {
        const R = 6371000, dLat = (lat2-lat1)*Math.PI/180, dLon = (lon2-lon1)*Math.PI/180;
        const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }
</script>
</body>
</html>
